<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>freq chart</title> 
</head>
<body>

<div id="current-users">---</div>
<label for="area-selector">Area</label>
<select id="area-selector" onchange="areaSelectUpdate(this.value);">
<option value="kyoto" selected>Kyoto(60Hz)</option >
<option value="tokyo">Tokyo(50Hz)</option>
</select>

<!--
<div id="area-chooser">
    <label><input type="checkbox" value="kyoto" onchange="areaChoose(this)">Kyoto(60Hz)</label>
    <label><input type="checkbox" value="tokyo" onchange="areaChoose(this)">Tokyo(50Hz)</label>
</div>
-->

<div id="ambient">
You can see more long span data at <a href="https://ambidata.io/bd/board.html?id=37603">Ambient</a>.
</div>
<div class="chart-container" style="height:40vh; width:80vw">    
<canvas id="freqChart"></canvas>
<button type="button" onclick="resetZoon();"> reset zoom / pan </button>
</div>
<!-- import libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js" integrity="sha512-QSkVNOCYLtj73J4hbmVoOV6KVZuMluZlioC+trLpewV8qMjsWqlIQvkn1KGX2StWvPMdWGBqim1xlC8krl1EKQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.0/chartjs-adapter-moment.min.js" integrity="sha512-oh5t+CdSBsaVVAvxcZKy3XJdP7ZbYUBSRCXDTVn0ODewMDDNnELsrG9eDm8rVZAQg7RsDD/8K3MjPAFB13o6eA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" integrity="sha512-UXumZrZNiOwnTcZSHLOfcTs0aos2MzBWHXOHOuB0J/R44QB0dwY5JgfbvljXcklVf65Gc4El6RjZ+lnwd2az2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.0/chartjs-plugin-zoom.min.js" integrity="sha512-TT0wAMqqtjXVzpc48sI0G84rBP+oTkBZPgeRYIOVRGUdwJsyS3WPipsNh///ay2LJ+onCM23tipnz6EvEy2/UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-streaming/2.0.0/chartjs-plugin-streaming.min.js" integrity="sha512-pSxAn0V22F4p92VllULJWP5yR5a5FfSPCzHum2P7MrbzmYNiaYsED0UZUF9JzRSZvRlemas5Yqf7F90xFvFthA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- code -->
<script>
function setupChart(){
    const ctx = document.getElementById('freqChart').getContext('2d');
    const config = {
        type: 'line',
        data: {
            labels: [], // not in use
            datasets: [{
                label: 'Kyoto',
                data: [],
                borderColor: "rgb(0, 191, 255)",
                hidden: true,
                place_id: 'kyoto',
            },{
                label: 'Tokyo',
                data: [],
                borderColor:'rgb(0, 204, 102)',
                hidden: true,
                place_id: 'tokyo',
            }]
        },
        options :{
            pointRadius: 1,
            scales: {
                x: {
                    type: 'realtime',
                    realtime:{
                        duration: 10*60*1000
                    }
                },
                y:{
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (ctx) => ctx.dataset.label+ ": " + ctx.raw.y + "Hz",
                    },
                },
                legend: {
                    labels: {
                        usePointStyle: true,
                    },
                    onClick: () => false
                },
                zoom: {
                    pan: {
                        enabled: true,
                        mode: "x"
                    },
                    zoom: {
                            wheel: {
                            enabled: true,
                        },
                    pinch: {
                        enabled: true
                        },
                    mode: "x",
                    }
                },
            },
        }
    };

    const freqChart = new Chart(ctx, config);

    window.freqChartData = {
        "chart": freqChart,
        "config": config,
        "wsc":[null,null,null]
    }
}

function beginChartDrawing(target,place){
    const dumpUri = target + 'dump?place=' + place;
    const textModMsg = document.getElementById('current-users');

    const freqChart = window.freqChartData.chart;
    const chartConfig = window.freqChartData.config;

    const dataLoader = (place) => {
        const placeIndex = chartConfig.data.datasets.findIndex( it => it. place_id === place);
        if (placeIndex < 0){
            console.log("cannot find starting place:"+place);
            return;
        }
        if(!chartConfig.data.datasets[placeIndex].hidden){
            console.log("already shown place:"+place);
            return;
        }
        if(window.freqChartData.wsc[placeIndex] !== null){
                window.freqChartData.wsc[placeIndex].close();
                window.freqChartData.wsc[placeIndex] = null;
        }
        const data = [];
        chartConfig.data.datasets[placeIndex].data = data;

        fetch(dumpUri).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not OK');
            }
            return response.json();
        }).then(dumpData => {
            console.log(dumpUri);
            if(!Array.isArray(dumpData)){
                return;
            }

            dumpData.forEach(element => {
                data.unshift({x:new Date(1000 * element.t),y:element.f});
            });

            chartConfig.data.datasets[placeIndex].hidden = false;
            freqChart.update('quiet');
        }).then(() => {
            const wsUriBase = new URL(target);
            wsUriBase.protocol = wsUriBase.protocol === 'http:' ? 'ws:' : 'wss:';
            const wsUri = wsUriBase + 'ws?place=' +place;
            const wsc = new WebSocket(wsUri);

            wsc.onopen = () => window.freqChartData.wsc[placeIndex] = wsc;
            
            wsc.onmessage = event => {
                const element = JSON.parse(event.data);
                data.push({x:new Date(1000 * element.t),y:element.f});
                textModMsg.textContent = element.c + "users.";
                freqChart.update('quiet');
            };

            wsc.onclose = event => {
                if(window.freqChartData.wsc[placeIndex] !== null){
                    // re-load data and connect websocket
                    dataLoader(place);
                }
            };

        }).catch(reason => {
            console.log("Fetch error place_index:"+placeIndex+" place:"+place);
            chartConfig.data.datasets[placeIndex].data = [];
            chartConfig.data.datasets[placeIndex].hidden = true;
            freqChart.update('quiet');
            textModMsg.textContent = reason;
        })
    };

    // load data and connect websocket.
    dataLoader(place);
}

function endChartDrawing(place){
    const placeIndex = window.freqChartData.config.data.datasets.findIndex( it => it. place_id === place);
    if (placeIndex < 0){
        console.log("cannot find closing place:"+place);
        return;
    }

    const closingWs = window.freqChartData.wsc[placeIndex];
    window.freqChartData.wsc[placeIndex] = null;
    if(closingWs !== null){
        closingWs.close();
    }

    window.freqChartData.config.data.datasets[placeIndex].data = [];
    window.freqChartData.config.data.datasets[placeIndex].hidden = true;
    window.freqChartData.chart.update('quiet');
}
const targetHost = 'https://www2.zxvf.jp/freqWatch/d/';
//const targetHost = 'http://localhost:8080/';

function areaChoose(obj){
    if(obj.checked){
        beginChartDrawing(targetHost,obj.value);
    }else{
        endChartDrawing(obj.value);
    }
}

function areaSelectUpdate(place){
    const areaSelector = document.getElementById( "area-selector" );
    if(place === null){
        place = areaSelector.options[areaSelector.selectedIndex].value;
    }
    Array.prototype.forEach.call(areaSelector.options,(it) => endChartDrawing(it.value));
    beginChartDrawing(targetHost,place);
}
function initialize(){
    setupChart();
    areaSelectUpdate(null);
}
function resetZoon(){
    window.freqChartData?.chart?.resetZoom();
}
</script>
<script>
initialize();
</script>


</body></html>
